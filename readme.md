# 全局描述符表 (GDT) 与 段描述符 详解

## 1. 全局描述符表 (GDT)
全局描述符表 (Global Descriptor Table) 是保护模式下用于内存段管理的核心数据结构。它是一个数组，数组中的每个元素称为**段描述符 (Segment Descriptor)**。
- **作用**：提供段式内存管理，定义内存段的起始地址、大小、属性（如权限、类型）。
- **位置**：存放在内存中，由 `GDTR` 寄存器指向。
- **第0个描述符**：必须是空描述符 (Null Descriptor)，不可使用。

## 2. 段描述符 (Segment Descriptor)
每个段描述符占用 **8字节 (64位)**，结构非常紧凑。

### 2.1 结构图解
```text
高地址 (High Address)                                            低地址 (Low Address)
+---------------------------------------------------------------+
|   Base 24:31   | G | D | L | AVL | Limit | P | DPL | S | Type |   Base 16:23   |
|     (8 bits)   |   | / |   |     | 16:19 |   |     |   |      |    (8 bits)    |
|                |   | B |   |     |(4 bits)|   |(2b) |   |(4b)  |                |
+---------------------------------------------------------------+
|             Base Address 0:15             |           Segment Limit 0:15          |
|                 (16 bits)                 |               (16 bits)               |
+---------------------------------------------------------------+
```

### 2.2 字段详解

#### A. 段界限 (Segment Limit) - 20位
- **位置**：低32位的 0-15 bit，高32位的 16-19 bit。
- **作用**：表示段的大小。
- **实际大小**：取决于 **G (Granularity)** 位。
    - **G=0**：单位为字节 (Byte)。最大范围 $2^{20} - 1 = 1MB$。
    - **G=1**：单位为 4KB (Page)。最大范围 $(2^{20} - 1) \times 4KB = 4GB$。

#### B. 段基址 (Base Address) - 32位
- **位置**：分散在三个部分（低32位的16-31，高32位的0-7，高32位的24-31）。
- **作用**：段在线性地址空间中的起始地址。

#### C. 属性位 (Attributes)

1.  **P (Present) - 1位**
    - `1`：段存在于内存中。
    - `0`：段不存在（访问会触发 #NP 异常）。

2.  **DPL (Descriptor Privilege Level) - 2位**
    - 特权级，范围 0-3。
    - `0`：最高特权（内核态）。
    - `3`：最低特权（用户态）。

3.  **S (System) - 1位**
    - `1`：代码段或数据段（非系统段）。
    - `0`：系统段（如门描述符、TSS）。

4.  **Type - 4位**
    - 决定段的具体类型（读写执行权限）。
    - **当 S=1 (代码/数据段) 时**：
        - **第3位 (E, Executable)**：
            - `0`：数据段 (Data Segment)。
                - 第2位 (ED, Expand Down)：扩展方向（0=向上，1=向下/栈）。
                - 第1位 (W, Writable)：可写（0=只读，1=可读写）。
                - 第0位 (A, Accessed)：已访问位（CPU自动置1）。
            - `1`：代码段 (Code Segment)。
                - 第2位 (C, Conforming)：一致性代码段（0=非一致，1=一致）。
                - 第1位 (R, Readable)：可读（0=只执行，1=可读可执行）。
                - 第0位 (A, Accessed)：已访问位。

5.  **AVL (Available) - 1位**
    - 留给系统软件（操作系统）使用，硬件不关心。

6.  **L (Long Mode) - 1位**
    - `1`：64位代码段。
    - `0`：32位兼容模式。

7.  **D/B (Default Operation Size) - 1位**
    - **对于代码段 (D)**：
        - `1`：32位指令（默认操作数和地址大小为32位）。
        - `0`：16位指令。
    - **对于栈段 (B)**：
        - `1`：使用 ESP 寄存器。
        - `0`：使用 SP 寄存器。

8.  **G (Granularity) - 1位**
    - 见“段界限”。

## 3. 段选择子 (Segment Selector)
段寄存器（CS, DS, ES, SS, FS, GS）中存储的不是段基址，而是**段选择子**。
- **结构 (16位)**：
  ```
  15                      3 2   0
  +------------------------+-+---+
  |      Index (索引)      |T|RPL|
  |                        |I|   |
  +------------------------+-+---+
  ```
- **Index (13位)**：GDT中描述符的索引（下标）。
- **TI (Table Indicator)**：`0` = GDT，`1` = LDT。
- **RPL (Requested Privilege Level)**：请求特权级 (0-3)。

## 4. GDTR 寄存器
- **作用**：存储 GDT 的地址和大小。
- **结构 (48位)**：
    - **Limit (16位)**：表界限（字节数 - 1）。
    - **Base (32位)**：GDT 的线性基地址。
- **指令**：`lgdt [ptr]` 加载 GDTR。